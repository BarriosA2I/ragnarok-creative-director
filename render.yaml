# ================================================================================
# RENDER.YAML - RAGNAROK VIDEO PRODUCTION INFRASTRUCTURE
# ================================================================================
# Barrios A2I Commercial Video Generation Platform
#
# Features:
# - Persistent disk for video assets (survives container restarts)
# - WebSocket-optimized web service
# - Background worker for payment processing
# - Health checks with proper intervals
#
# Deploy: Connect GitHub repo to Render, it auto-detects this file
# ================================================================================

services:
  # ===========================================================================
  # 1. MAIN API SERVER (FastAPI + WebSockets)
  # ===========================================================================
  - type: web
    name: ragnarok-api
    runtime: python
    region: ohio
    plan: starter

    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    startCommand: |
      uvicorn api.websocket_server:app \
        --host 0.0.0.0 \
        --port $PORT \
        --workers 1 \
        --ws-ping-interval 20 \
        --ws-ping-timeout 30 \
        --timeout-keep-alive 120

    healthCheckPath: /health

    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: KIE_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: OTEL_EXPORTER_OTLP_ENDPOINT
        value: ""
      - key: LOG_LEVEL
        value: "INFO"
      - key: VIDEO_OUTPUT_DIR
        value: "/var/data/videos"
      - key: LOGS_DIR
        value: "/var/data/logs"
      - key: ENABLE_VOICE_SYNTHESIS
        value: "false"
      - key: ENVIRONMENT
        value: "production"

    disk:
      name: ragnarok-storage
      mountPath: /var/data
      sizeGB: 5

  # ===========================================================================
  # 2. V8.0 APEX BACKGROUND ORCHESTRATOR
  # ===========================================================================
  # Netflix-grade resilience: Circuit breakers, DLQ, graceful shutdown
  # ===========================================================================
  - type: worker
    name: ragnarok-orchestrator
    runtime: python
    region: ohio
    plan: starter

    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    startCommand: python workers/background_orchestrator.py

    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: KIE_API_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        value: "Barrios A2I <director@barriosa2i.com>"
      - key: WEBSITE_URL
        value: "https://barriosa2i.com"
      - key: LOG_LEVEL
        value: "INFO"
      - key: METRICS_PORT
        value: "9090"

    disk:
      name: ragnarok-storage
      mountPath: /var/data
      sizeGB: 5
